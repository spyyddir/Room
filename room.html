<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
	"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
	<head>
		<title></title>
		<style type="text/css">
		* 						{margin: 0; padding: 0;}
		body 					{margin: 10px; font-family: "Arial";}
		#room					{border: 3px solid #000; border-right: 0; position: relative;}
		#controls			{float: left; padding: 5px;}
		#controls a		{display: block; color: #fff; text-decoration: none; padding: 4px 8px; background: #333;}
		</style>
		<script type="text/javascript" charset="utf-8" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js"></script>
		<script type="text/javascript" charset="utf-8" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.14/jquery-ui.min.js"></script>
		<script type="text/javascript" charset="utf-8">
			$(document).ready(function(){
				// globals
				saving = true;
				double_click_seconds = 0.5;
				$('#saving').toggle(function(){
					$(this).text('Turn saving on')
					saving = false;
				},function(){
					$(this).text('Turn saving off')
					saving = true;
				});
				// start main
				var scaling_factor = 2.5;
				var dim_to_px = function(dim) {
					return dim*scaling_factor;
				}
				var px_to_dim = function(px) {
					return px/scaling_factor;
				}
				
				var room_dim = [168, 174.5 + 41 + 6];
				var room = $('<div id="room"></div>');
				
				room.css({
					width:dim_to_px(room_dim[0]),
					height:dim_to_px(room_dim[1]),
					float: 'left'
				});
				$('body').append(room);
				
				var fplace = $('<div></div>');
				fplace_dim = [22, 102.5];
				fplace.css({
					width: dim_to_px( fplace_dim[0] ) - 2,
					height: dim_to_px( fplace_dim[1] ) - 4,
					top: dim_to_px( 60 ),
					right: 0,
					position:'absolute',
					border: "2px solid #000",
					"border-right":"0"
				});
				
				room.append(fplace);
				
				var tile = $('<div></div>');
				tile_dim = [20, 102.5];
				tile.css({
					width: dim_to_px( tile_dim[0] ),
					height: dim_to_px( tile_dim[1] ),
					position: "absolute",
					right: dim_to_px( fplace_dim[0] ),
					top: dim_to_px( 60 ),
					background:'#ddd'
				});
				
				room.append(tile);
				
				var pieces = [
					{
						title: 'Coffee Table',
						width: 39,
						height: 19
					},
					{
						title: 'Sactional',
						width: 78,
						height: 36
					},
					{
						title: 'Papasan',
						width: 50,
						height: 50,
						circle: true
					},
					{
						title: 'TV',
						width: 41,
						height: 15.5
					},
					{
						title: 'Side Table',
						width: 20,
						height: 20
					},
					{
						title: 'Futon Couch',
						width: 35,
						height: 77
					},
					{
						title: 'Lamp',
						width: 12,
						height: 12,
						circle: true
					}
				];
				
				$.each(pieces, function(i, piece){
					var elem = $('<div></div>');
					var title = $('<span>' + piece.title + '</span>');
					var rotated = false;
					
					var save = function() {
						if (saving) {
							window.localStorage[piece.title] = [
								px_to_dim( elem.css('top').replace('px', '') ),
								px_to_dim( elem.css('left').replace('px', '') ),
								rotated
							].join(",")
						}
					}
					
					if ( typeof(window.localStorage[piece.title]) != 'undefined' ) {
						var arr = window.localStorage[piece.title].split(",");
						elem.css({
							top: dim_to_px( parseInt(arr[0]) ),
							left: dim_to_px( parseInt(arr[1]) )
						});
						if (arr[2] == "true") {
							rotated = true;
						}
					}
					
					elem.append(title);
					
					var style = function(){
						var style_height = dim_to_px(piece.height) - 2;
						var style_width  = dim_to_px(piece.width) - 2;
						
						if (rotated) {
							var temp = style_height;
							style_height = style_width;
							style_width = temp;
						}
						
						title.css({
							display:'block',
							"margin-top":(style_height / 2) - 10
						});
						elem.css({
							position: 'absolute',
							width: style_width,
							height: style_height,
							border: '1px solid #000',
							cursor: 'pointer',
							overflow: 'hidden',
							"text-align": "center",
							"font-size":'10px',
							background:'rgba(255,255,255,0.8)'
						});
					}
					style();
					
					if ( typeof(piece.circle) != 'undefined' && piece.circle == true ){
						elem.css({
							"-webkit-border-radius":dim_to_px(piece.width)
						});
					}
					room.append(elem);
					elem.draggable({
						containment: "parent",
						stop: function(){
							// var offsetTop = $(this).css('top');
							// var offsetLeft = $(this).css('left');
							// if (saving) window.localStorage[piece.title] = offsetTop + "," + offsetLeft;
							save();
						}
					});
					var last_click_time = Date.now();
					elem.click(function(){
						var this_click_time = Date.now();
						if (this_click_time - last_click_time < double_click_seconds * 1000) {
							rotated = !rotated;
							style();
							save();
						}
						last_click_time = this_click_time;
					});
				});
			});
		</script>
	</head>
	<body>
		<div id="controls">
			<a href="#" id="saving">Turn saving off</a>
		</div>
	</body>
</html>